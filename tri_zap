import requests

# Configuration
SOURCE_URL = "https://tvradiozap.eu/live/g/1/x/vlc/d/tvzeu.m3u"
OUTPUT_FILE = "playlist_complete.m3u"

def process_playlist():
    print(f"T√©l√©chargement de la playlist compl√®te...")
    try:
        response = requests.get(SOURCE_URL, timeout=30)
        response.raise_for_status()
    except Exception as e:
        print(f"Erreur : {e}")
        return

    lines = response.text.splitlines()
    new_m3u = ["#EXTM3U"]
    
    current_inf = None

    for line in lines:
        if line.startswith("#EXTM3U"):
            continue
            
        if line.startswith("#EXTINF:"):
            # On analyse les attributs pour le classement
            info_lower = line.lower()
            
            # D√©termination de la cat√©gorie
            if "pluto" in info_lower:
                new_group = "üì∫ PLUTO TV"
            elif "samsung" in info_lower:
                new_group = "üì∫ SAMSUNG TV PLUS"
            elif "rakuten" in info_lower:
                new_group = "üì∫ RAKUTEN TV"
            elif "sony" in info_lower:
                new_group = "üì∫ SONY"
            else:
                new_group = None # On ne change rien

            # Si on a trouv√© une correspondance, on remplace le group-title
            if new_group:
                # Utilisation d'une regex simple ou remplacement de texte
                if 'group-title="' in line:
                    # On remplace le groupe existant par le n√¥tre
                    start = line.find('group-title="') + 13
                    end = line.find('"', start)
                    line = line[:start] + new_group + line[end:]
                else:
                    # Si pas de groupe, on l'ajoute avant le nom de la cha√Æne (apr√®s la virgule finale ou avant)
                    line = line.replace('#EXTINF:', f'#EXTINF:-1 group-title="{new_group}" ')

            current_inf = line
            
        elif line.startswith("http"):
            if current_inf:
                new_m3u.append(current_inf)
                new_m3u.append(line)
                current_inf = None
            else:
                # Cas o√π il y aurait une URL sans #EXTINF pr√©c√©dent
                new_m3u.append(line)

    # Sauvegarde du fichier complet
    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        f.write("\n".join(new_m3u))

    print(f"Termin√© ! Playlist compl√®te sauvegard√©e dans : {OUTPUT_FILE}")

if __name__ == "__main__":
    process_playlist()
